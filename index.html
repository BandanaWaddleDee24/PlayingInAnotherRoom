<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Other Room Audio Effect</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        input, button { margin: 10px; display: block; width: 80%; max-width: 400px; }
    </style>
</head>
<body>
<h2>Upload an MP3 to Hear It from Another Room</h2>
<input type="file" id="audioFile" accept=".mp3, audio/*">
<button onclick="applyEffect()">Apply Effect</button>
<audio id="audio" controls></audio>

<script>
    let audioCtx, source, lowPassFilter, gainNode, audioBuffer, isPlaying = false;

    function applyEffect() {
        const fileInput = document.getElementById('audioFile');

        if (fileInput.files.length === 0) {
            alert("Please upload an audio file!");
            return;
        }

        const file = fileInput.files[0];
        const objectURL = URL.createObjectURL(file);

        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        fetch(objectURL)
            .then(response => response.arrayBuffer())
            .then(data => audioCtx.decodeAudioData(data))
            .then(buffer => {
                audioBuffer = buffer;
            })
            .catch(error => console.error("Error processing audio:", error));
    }

    function togglePlayPause() {
        if (!audioBuffer) {
            alert("No audio loaded!");
            return;
        }

        if (isPlaying) {
            source.stop();
            isPlaying = false;
            return;
        }

        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;

        // Low-pass filter
        lowPassFilter = audioCtx.createBiquadFilter();
        lowPassFilter.type = "lowpass";
        lowPassFilter.frequency.setValueAtTime(1500, audioCtx.currentTime);
        lowPassFilter.Q.setValueAtTime(0.7, audioCtx.currentTime);

        // Gain node
        gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(0.6, audioCtx.currentTime);

        source.connect(lowPassFilter);
        lowPassFilter.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        source.start();
        isPlaying = true;
    }

    // âœ… Background Audio Fix: Resume when page becomes visible
    document.addEventListener("visibilitychange", () => {
        if (audioCtx && audioCtx.state === "suspended") {
            audioCtx.resume();
        }
    });

</script>

</body>
</html>
