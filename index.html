<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist with Audio Effect</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        input, button { margin: 10px; display: block; width: 80%; max-width: 400px; }
        #playlist { list-style: none; padding: 0; }
        #playlist li { padding: 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
        #playlist li.active { font-weight: bold; color: green; }
    </style>
</head>
<body>
<h2>Upload Multiple MP3s to Create a Playlist</h2>
<input type="file" id="audioFiles" accept=".mp3, audio/*" multiple>
<label>
    <input type="checkbox" id="loopPlaylist"> Loop Playlist
</label>
<button onclick="playPlaylist()">Play Playlist</button>
<button onclick="pauseAudio()">Pause</button>
<button onclick="nextTrack()">Skip to Next</button>
<ul id="playlist"></ul>
<audio id="audio" controls></audio>

<script>
    let audioElement = document.getElementById('audio');
    let audioCtx, mediaElementSource, lowPassFilter, gainNode;
    let playlist = [];
    let currentTrackIndex = 0;
    let loopPlaylist = false;

    document.getElementById('loopPlaylist').addEventListener('change', (event) => {
        loopPlaylist = event.target.checked;
    });

    function playPlaylist() {
        const fileInput = document.getElementById('audioFiles');
        if (fileInput.files.length === 0) {
            alert("Please upload audio files!");
            return;
        }

        // Clear previous playlist
        playlist = [];
        currentTrackIndex = 0;

        // Get selected files
        const fileList = Array.from(fileInput.files);
        const playlistElement = document.getElementById('playlist');
        playlistElement.innerHTML = ''; // Clear previous list

        fileList.forEach((file, index) => {
            const objectURL = URL.createObjectURL(file);
            playlist.push({ name: file.name, url: objectURL });

            // Add to visual playlist
            const listItem = document.createElement('li');
            listItem.textContent = file.name;
            listItem.addEventListener('click', () => playSpecificTrack(index));
            playlistElement.appendChild(listItem);
        });

        // Start playing first track
        applyEffectAndPlay(0);
    }

    function applyEffectAndPlay(index) {
        if (index < 0 || index >= playlist.length) return;

        currentTrackIndex = index;
        audioElement.src = playlist[index].url;
        audioElement.play().catch(err => console.error("Play error:", err));

        // Ensure AudioContext is not suspended
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } else if (audioCtx.state === "suspended") {
            audioCtx.resume();
        }

        if (mediaElementSource) {
            mediaElementSource.disconnect();
        }

        // Apply "Other Room Effect"
        mediaElementSource = audioCtx.createMediaElementSource(audioElement);
        lowPassFilter = audioCtx.createBiquadFilter();
        lowPassFilter.type = "lowpass";
        lowPassFilter.frequency.setValueAtTime(2500, audioCtx.currentTime);
        lowPassFilter.Q.setValueAtTime(0.7, audioCtx.currentTime);

        gainNode = audioCtx.createGain();
        gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);

        mediaElementSource.connect(lowPassFilter);
        lowPassFilter.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        updatePlaylistUI();
    }

    function playSpecificTrack(index) {
        applyEffectAndPlay(index);
    }

    function nextTrack() {
        if (currentTrackIndex + 1 < playlist.length) {
            applyEffectAndPlay(currentTrackIndex + 1);
        } else if (loopPlaylist) {
            applyEffectAndPlay(0);
        }
    }

    function pauseAudio() {
        audioElement.pause();
    }

    function updatePlaylistUI() {
        const playlistItems = document.querySelectorAll("#playlist li");
        playlistItems.forEach((item, index) => {
            item.classList.toggle("active", index === currentTrackIndex);
        });
    }

    // Auto-play next track when the current one ends
    audioElement.addEventListener('ended', () => {
        nextTrack();
    });

</script>
</body>
</html>
